{#{% extends "base.html" %}#}
{#{% block title %}{{ course.title }}{% endblock %}#}
{##}
{#{% block content %}#}
{#<div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">#}
{#    <h2 class="text-2xl font-bold mb-4">{{ course.title }}</h2>#}
{#    <p class="text-gray-700">{{ course.description }}</p>#}
{#    <p class="mt-2 font-bold">–¶–µ–Ω–∞: {{ course.price }} –ª–≤.</p>#}
{##}
{#    {% if course.video_url %}#}
{#        <p class="mt-4"><a href="{{ course.video_url }}" class="text-blue-600 hover:underline">–ì–ª–µ–¥–∞–π –≤–∏–¥–µ–æ—Ç–æ</a></p>#}
{#    {% endif %}#}
{##}
{#    {% if course.document %}#}
{#        <p class="mt-4"><a href="{{ course.document.url }}" class="text-blue-600 hover:underline">–ò–∑—Ç–µ–≥–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</a></p>#}
{#    {% endif %}#}
{#</div>#}
{#{% endblock %}#}


{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}

{% block content %}
    {#    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">#}
    {#        <h2 class="text-2xl font-bold mb-4">{{ course.title }}</h2>#}
    {##}
    {#        <p class="text-gray-700">{{ course.description }}</p>#}
    {##}
    {#        {% if request.user.is_authenticated %}#}
    {#            {% if lesson not in request.user.completedlesson_set.all %}#}
    {#                <form action="{% url 'mark_lesson_completed' lesson.id %}" method="POST">#}
    {#                    {% csrf_token %}#}
    {#                    <button type="submit" class="bg-green-500 px-4 py-2 text-white rounded-lg hover:bg-green-700">#}
    {#                        ‚úÖ –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –∑–∞–≤—ä—Ä—à–µ–Ω#}
    {#                    </button>#}
    {#                </form>#}
    {#            {% else %}#}
    {#                <p class="text-green-600 font-bold mt-2">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω —É—Ä–æ–∫</p>#}
    {#            {% endif %}#}
    {#        {% endif %}#}
    {##}
    {##}
    {#        {% if course.quizzes.all %}#}
    {#            <h3 class="text-xl font-bold mt-4">üìù –¢–µ—Å—Ç–æ–≤–µ</h3>#}
    {#            <ul class="list-disc pl-6">#}
    {#                {% for quiz in course.quizzes.all %}#}
    {#                    <li>#}
    {#                        <a href="{% url 'quiz_detail' quiz.id %}" class="text-blue-600 hover:underline">#}
    {#                            {{ quiz.title }}#}
    {#                        </a>#}
    {#                    </li>#}
    {#                {% endfor %}#}
    {#            </ul>#}
    {#        {% else %}#}
    {#            <p class="mt-4 text-gray-500">‚ùå –ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ –∑–∞ —Ç–æ–∑–∏ –∫—É—Ä—Å.</p>#}
    {#        {% endif %}#}
    {##}
    {##}
    {#        <p class="mt-2 font-bold">–¶–µ–Ω–∞: {{ course.price }} –ª–≤.</p>#}
    {##}
    {#        {% if course.video_url %}#}
    {#            <p class="mt-4">#}
    {#                <a href="{{ course.video_url }}" class="text-blue-600 hover:underline">–ì–ª–µ–¥–∞–π –≤–∏–¥–µ–æ—Ç–æ</a>#}
    {#            </p>#}
    {#        {% endif %}#}
    {##}
    {#        {% if course.document %}#}
    {#            <p class="mt-4">#}
    {#                <a href="{{ course.document.url }}" class="text-blue-600 hover:underline">–ò–∑—Ç–µ–≥–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</a>#}
    {#            </p>#}
    {#        {% endif %}#}
    {##}
    {#        <!-- –¢–µ—Å—Ç–≤–∞ –¥–∞–ª–∏ Stripe –∫–ª—é—á—ä—Ç —Å–µ –∑–∞—Ä–µ–∂–¥–∞ -->#}
    {#        <p>Stripe –∫–ª—é—á: <span id="stripe-key">{% if STRIPE_PUBLISHABLE_KEY %}{{ STRIPE_PUBLISHABLE_KEY }}{% else %}–ù—è–º–∞ –∫–ª—é—á{% endif %}</span></p>#}
    {##}
    {##}
    {#        <!-- Stripe –ø–ª–∞—â–∞–Ω–µ -->#}
    {#        <form id="payment-form" class="mt-6">#}
    {#            <button id="checkout-button"#}
    {#                    class="bg-green-500 px-4 py-2 text-white rounded-lg hover:bg-green-700"#}
    {#                    data-stripe-key="{{ STRIPE_PUBLISHABLE_KEY }}">#}
    {#                –ü–ª–∞—Ç–∏ —Å –∫–∞—Ä—Ç–∞#}
    {#            </button>#}
    {#        </form>#}
    {#    </div>#}

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <!-- –ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –∫—É—Ä—Å–∞ -->
        <h2 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">{{ course.title }}</h2>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∫—É—Ä—Å–∞ -->
        <p class="text-gray-700 text-lg leading-relaxed mb-6">{{ course.description }}</p>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫—É—Ä—Å–∞ -->
        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <p class="text-lg font-semibold">üí∞ –¶–µ–Ω–∞: <span class="text-green-600">{{ course.price }} –ª–≤.</span></p>
            {% if course.video_url %}
                <p class="mt-2">
                    üé• <a href="{{ course.video_url }}" class="text-blue-600 font-semibold hover:underline">
                    –ì–ª–µ–¥–∞–π –≤–∏–¥–µ–æ—Ç–æ
                </a>
                </p>
            {% endif %}
            {% if course.document %}
                <p class="mt-2">
                    üìÑ <a href="{{ course.document.url }}" class="text-blue-600 font-semibold hover:underline">
                    –ò–∑—Ç–µ–≥–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                </a>
                </p>
            {% endif %}
        </div>

        <!-- –ú–∞—Ä–∫–∏—Ä–∞–Ω–µ –Ω–∞ —É—Ä–æ–∫ –∫–∞—Ç–æ –∑–∞–≤—ä—Ä—à–µ–Ω -->
        {% if request.user.is_authenticated %}
            <div class="text-center">
                {% for lesson in lessons %}
                    <div class="bg-gray-100 p-4 rounded-lg mt-4">
                        <h4 class="font-bold text-lg">{{ lesson.title }}</h4>
                        <p class="text-gray-700">{{ lesson.content }}</p>

                        {% if lesson not in request.user.completedlesson_set.all %}
                            <form action="{% url 'mark_lesson_completed' lesson.id %}" method="POST">
                                {% csrf_token %}
                                <button type="submit"
                                        class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition">
                                    ‚úÖ –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –∑–∞–≤—ä—Ä—à–µ–Ω
                                </button>
                            </form>
                        {% else %}
                            <p class="text-green-600 font-bold mt-2">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω —É—Ä–æ–∫</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}


        <!-- –¢–µ—Å—Ç–æ–≤–µ –∑–∞ –∫—É—Ä—Å–∞ -->
        <div class="mt-6">
            {% if course.quizzes.all %}
                <h3 class="text-2xl font-bold text-gray-900 mb-2">üìù –¢–µ—Å—Ç–æ–≤–µ</h3>
                <ul class="list-disc pl-6">
                    {% for quiz in course.quizzes.all %}
                        <li class="mb-2">
                            <a href="{% url 'quiz_detail' quiz.id %}"
                               class="text-blue-600 font-semibold hover:underline">
                                {{ quiz.title }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-500 text-lg">‚ùå –ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ –∑–∞ —Ç–æ–∑–∏ –∫—É—Ä—Å.</p>
            {% endif %}
        </div>

        <!-- Stripe –ø–ª–∞—â–∞–Ω–µ -->
        <div class="text-center mt-6">
            <form id="payment-form">
                <button id="checkout-button"
                        class="bg-green-500 text-red-50 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition"
                        data-stripe-key="{{ STRIPE_PUBLISHABLE_KEY }}">
                    üí≥ –ü–ª–∞—Ç–∏ —Å –∫–∞—Ä—Ç–∞
                </button>
            </form>
        </div>
    </div>


    <!-- –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Stripe.js –µ –∑–∞—Ä–µ–¥–µ–Ω!");

            // –í–∑–∏–º–∞–º Stripe –∫–ª—é—á–∞ –æ—Ç HTML
            {#const stripePublicKey = document.getElementById("stripe-key").innerText.trim();#}
            const stripePublicKey = document.getElementById("checkout-button").dataset.stripeKey;
            console.log("Stripe –∫–ª—é—á:", stripePublicKey);

            if (!stripePublicKey || stripePublicKey === "fallback-publishable-key") {
                console.error("–ì—Ä–µ—à–∫–∞: Stripe –∫–ª—é—á—ä—Ç –Ω–µ –µ –∫–æ—Ä–µ–∫—Ç–µ–Ω!");
                alert("–ì—Ä–µ—à–∫–∞: Stripe –∫–ª—é—á—ä—Ç –Ω–µ –µ –∑–∞–¥–∞–¥–µ–Ω –ø—Ä–∞–≤–∏–ª–Ω–æ. –°–≤—ä—Ä–∂–∏ —Å–µ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
                return;
            }

            const stripe = Stripe(stripePublicKey);

            document.getElementById("checkout-button").addEventListener("click", function (e) {
                e.preventDefault();
                console.log("–ë—É—Ç–æ–Ω—ä—Ç –∑–∞ –ø–ª–∞—â–∞–Ω–µ –µ –Ω–∞—Ç–∏—Å–Ω–∞—Ç!");

                fetch("{% url 'create_checkout_session' course.id %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                })
                    .then(response => response.json())
                    .then(session => {
                        console.log("Stripe —Å–µ—Å–∏—è —Å—ä–∑–¥–∞–¥–µ–Ω–∞:", session);
                        return stripe.redirectToCheckout({sessionId: session.sessionId});
                    })
                    .catch(error => {
                        console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–ª–∞—â–∞–Ω–µ:", error);
                        alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å—ä—Å Stripe. –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.");
                    });
            });
        });
    </script>
{% endblock %}

